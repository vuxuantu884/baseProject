"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/util"),r=require("@liff/ready"),n=require("@liff/is-logged-in"),o=require("@liff/store"),i=require("@liff/consts"),a=require("@liff/extensions"),s=require("@liff/is-in-client"),l=require("@liff/logout"),c=require("@liff/is-sub-window"),f=require("@liff/sub-window"),u=require("@liff/server-api"),d=require("@liff/logger"),g=require("@liff/get-line-version"),h=require("@liff/native-bridge"),_=require("@liff/is-api-available"),p=require("@liff/get-os"),v={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},I={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function w(){var e;F("color-scheme",((null==(e=o.getContext())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");b({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",b):t.addListener&&t.addListener(b)}function b(t){var r=o.getContext(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:v,darkModeColor:I},i=n.adaptableColorSchemes,a=n.lightModeColor,s=n.darkModeColor,l=i.includes("dark");t.matches&&l?C(e.__assign(e.__assign({},I),s)):C(e.__assign(e.__assign({},v),a))}function C(e){var r=e.iconColor,n=e.statusBarColor,o=e.titleTextColor,i=e.titleSubtextColor,a=e.titleButtonColor,s=e.titleBackgroundColor,l=e.progressBarColor,c=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,u=e.titleButtonAreaBorderColor,d=e.baseBackgroundColor,g=e.baseTextColor,h=e.lightButtonBorderColor;F("--liff-base-background-color",d),F("--liff-base-text-color",g),F("--liff-base-background-rgb-color",t.convertHexToRgb(d)),F("--liff-base-text-rgb-color",t.convertHexToRgb(g)),F("--liff-light-button-border-color",h),F("--liff-title-text-color",o),F("--liff-title-background-color",s),F("--liff-title-button-color",a),F("--liff-icon-color",r),F("--liff-status-bar-color",n),F("--liff-title-subtext-color",i),F("--liff-progress-bar-color",l),F("--liff-progress-background-color",c),F("--liff-title-button-area-background-color",t.convertArgbToRgba(f)),F("--liff-title-button-area-border-color",t.convertArgbToRgba(u))}function F(e,t){document.documentElement.style.setProperty(e,t)}function T(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,a.load()];case 1:return e.sent().install(t),[2]}}))}))}function m(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,u.fetch(u.getEndPoint("certs"))];case 1:return[2,e.sent()]}}))}))}function k(t,r,n){return e.__awaiter(this,void 0,void 0,(function(){var o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,crypto.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 1:return o=e.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,n,r)];case 2:return[2,e.sent()]}}))}))}function L(r,n){return e.__awaiter(this,void 0,void 0,(function(){var o,a,s,l,c,f,u,d,g,h,_,p,v,I,w,b;return e.__generator(this,(function(C){switch(C.label){case 0:return o=r.split("."),a=e.__read(o,3),s=a[0],l=a[1],c=a[2],f=JSON.parse(t.base64Url.decode(s)),u=JSON.parse(t.base64Url.decodeUnicode(l)),d=t.convertArrayBuffer(t.base64Url.decode(c)),g=t.convertArrayBuffer(s+"."+l),[4,m()];case 1:if(h=C.sent(),!(_=h.keys.find((function(e){return e.kid===f.kid}))))return[3,6];if(delete _.alg,"ES256"!==f.alg)throw t.createLiffError(i.INVALID_ID_TOKEN,'Invalid "alg" value in ID_TOKEN');p=void 0,C.label=2;case 2:return C.trys.push([2,4,,5]),[4,k(_,g,d)];case 3:return p=C.sent(),[3,5];case 4:throw v=C.sent(),t.createLiffError(i.INVALID_ID_TOKEN,"Failed to use Crypto API to verify ID_TOKEN: "+v);case 5:if(p){if(I="https://access.line.me"!==u.iss,w=u.aud!==n,b=1e3*u.exp<Date.now(),I)throw t.createLiffError(i.INVALID_ID_TOKEN,'Invalid "iss" value in ID_TOKEN');if(w)throw t.createLiffError(i.INVALID_ID_TOKEN,'Invalid "aud" value in ID_TOKEN');if(b)throw t.createLiffError(i.INVALID_ID_TOKEN,'Invalid "exp" value in ID_TOKEN');return[2,u]}throw t.createLiffError(i.INVALID_ID_TOKEN,"Invalid signature in ID_TOKEN");case 6:throw t.createLiffError(i.INVALID_ID_TOKEN,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function E(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function A(e){var r=e.pathname,n=e.query,o="liff://"+r+(n?"?"+t.qs.stringify(n):"");location.href=o}var D=null;function y(){"boolean"==typeof D&&d.logger.warn("liff.init is not expected to be called more than once"),D=!!o.getIsSubsequentLiffApp()||!(!s.isInClient()||t.qs.parse(window.location.hash).feature_token||o.getFeatureToken())&&(o.setIsSubsequentLiffApp(!0),!0)}function B(){return Boolean(D)}function S(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return(n=o.getMST())?[2,n]:t&&r?[4,f.getMSTByMSIT({msit:t,mstVerifier:r})]:[3,2];case 1:return[2,e.sent().mst];case 2:return[2,null]}}))}))}function x(e){return u.fetch(u.getEndPoint("apps")+"/"+e+"/featureToken")}function N(r){return e.__awaiter(this,void 0,void 0,(function(){var i,a,s,l;return e.__generator(this,(function(e){switch(e.label){case 0:return i=t.qs.parse(window.location.hash),a=t.objectAssignKeyOnlyWithValue({access_token:o.getAccessToken(),context_token:o.getRawContext(),feature_token:o.getFeatureToken(),id_token:o.getIDToken(),client_id:o.getClientId(),mst_challenge:o.getMSTChallenge(),mst_verifier:o.getMSTVerifier(),msit:o.getMSIT()},i),B()?n.isLoggedIn()?[4,x(r)]:[3,2]:[3,3];case 1:s=e.sent().featureToken,a.feature_token||(a.feature_token=s),e.label=2;case 2:(l=t.extractChannelIdFromLiffId(r))&&(a.client_id=l),e.label=3;case 3:return[2,a]}}))}))}function O(e){if(e.persisted&&_.isApiAvailable("multipleLiffTransition"))if("ios"===p.getOS())window.location.reload();else{var r=o.getConfig().liffId,n=o.getFeatureToken();if(!r)throw t.createLiffError(i.INIT_FAILED,"Invalid LIFF ID.");if(!n)throw t.createLiffError(i.FORBIDDEN,"Invalid featureToken for client features");A({pathname:"app/"+r,query:{feature_token:n}})}}function q(r,n){return e.__awaiter(this,void 0,void 0,(function(){var o,i;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,u.verifyAccessToken(r)];case 1:return o=e.sent().client_id,i=t.extractChannelIdFromLiffId(n),[2,o===i]}}))}))}function M(r,a){return e.__awaiter(this,void 0,void 0,(function(){var s,l,u,p,v,I,w,b,C,F,T,m,k;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var r=g.getLineVersion();if(!r||t.compareVersion(r,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{d.logger.debug("cannot find window._liff.features, listen to ready event");var n=function(){d.logger.debug("ready event is fired"),h.removeListener("ready",n),e()};h.addListener("ready",n)}}))];case 1:return e.sent(),y(),[4,N(a.liffId)];case 2:return s=e.sent(),l=s.access_token,u=s.context_token,p=s.feature_token,v=s.id_token,I=s.client_id,w=s.mst_verifier,b=s.mst_challenge,C=s.msit,u&&o.setContext(E(u)),!c.isSubWindow()&&p&&(!function(e,t){_.isApiAvailable("multipleLiffTransition")&&A({pathname:"app/"+e,query:{feature_token:t}})}(a.liffId,p),B()&&o.setFeatureToken(p)),b&&o.setMSTChallenge(b),w&&o.setMSTVerifier(w),I&&o.setClientId(I),C&&o.setMSIT(C),window.addEventListener("pageshow",O),n.isLoggedIn()?[3,7]:p&&l?[3,5]:B()?(F=t.addParamsToUrl(location.href,{"liff.hback":"2"}),r.login({redirectUri:F}),[4,new Promise((function(){}))]):[3,4];case 3:e.sent(),e.label=4;case 4:throw r.login(),t.createLiffError(i.INIT_FAILED,"Failed to parse feature_token or access_token");case 5:return[4,q(l,a.liffId)];case 6:if(!e.sent())throw r.login(),t.createLiffError(i.INIT_FAILED,"Failed to verify access_token");o.setFeatureToken(p),o.setAccessToken(l),e.label=7;case 7:return[4,S(C,w)];case 8:return(T=e.sent())?(o.setMST(T),[4,f.getAppData({mst:T})]):[3,10];case 9:(m=e.sent().data)&&o.setAppData(JSON.stringify(m)),e.label=10;case 10:return v&&!o.getIDToken()&&o.setIDToken(v),v&&I&&!o.getDecodedIDToken()?[4,L(v,I)]:[3,12];case 11:(k=e.sent())&&o.setDecodedIDToken(k),e.label=12;case 12:return[2]}}))}))}function U(r){return e.__awaiter(this,void 0,void 0,(function(){var n,a,s,l,c,f,d;return e.__generator(this,(function(e){switch(e.label){case 0:return n=u.getEndPoint("apps"),a=n+"/"+r+"/contextToken",s=o.getAccessToken(),l={"Content-Type":"application/json",Accept:"application/json"},s&&(l.Authorization="Bearer "+s),[4,u.fetch(a,{headers:l})];case 1:if(c=e.sent(),!(f=c.contextToken))throw t.createLiffError(i.INIT_FAILED,"Can not get context from server.");if(!(d=E(f)))throw t.createLiffError(i.INIT_FAILED,"Invalid context token.");return[2,d]}}))}))}function K(){return e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(r=o.getConfig().liffId))throw t.createLiffError(i.INIT_FAILED,"Invalid LIFF ID.");return[4,U(r)];case 1:return n=e.sent(),o.setContext(n),[2]}}))}))}function P(r){return e.__awaiter(this,void 0,void 0,(function(){var n,i,a,s=this;return e.__generator(this,(function(l){switch(l.label){case 0:n=function(){return e.__awaiter(s,void 0,void 0,(function(){var n,i,a,s,l,c;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(f=o.getConfig(),d=t.qs.parse(window.location.search),g=o.getLoginTmp(),h={grant_type:"authorization_code",client_id:d.liffClientId,appId:f.liffId,code:d.code,code_verifier:g.codeVerifier,redirect_uri:f.redirectUri||d.liffRedirectUri,id_token_key_type:"JWK"},_=t.qs.stringify(h),u.fetch(u.getEndPoint("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:_}))];case 1:return n=e.sent(),i=n.access_token,a=n.id_token,s=n.expires_in,o.setClientId(r),o.setAccessToken(i),o.setExpireTime(new Date(Date.now()+1e3*s)),o.removeLoginTmp(),a?(o.setIDToken(a),[4,L(a,r)]):[3,3];case 2:(l=e.sent())&&o.setDecodedIDToken(l),e.label=3;case 3:return(c=t.qs.parse(location.hash).context_token)?(o.setContext(E(c)),[3,6]):[3,4];case 4:return[4,K()];case 5:e.sent(),e.label=6;case 6:return[2]}var f,d,g,h,_}))}))},l.label=1;case 1:return l.trys.push([1,3,,4]),[4,n()];case 2:return l.sent(),[3,4];case 3:throw i=l.sent(),a=i,o.removeLoginTmp(),a;case 4:return[2]}}))}))}var W=new(function(){function r(){var e=this;this.getAndValidateContext=function(){var e=o.getContext();if(!e)throw t.createLiffError(i.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw t.createLiffError(i.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw t.createLiffError(i.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=!r.endpointUrl.startsWith("/?")&&r.endpointUrl.includes("/?")||!r.endpointUrl.startsWith("/#")&&r.endpointUrl.includes("/#")||r.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,l=new URL(""+i+e.attachSlashAtStart(t)),c=l.pathname,f=l.search,u=l.hash,d=""+s+(s?f.replace(/\?/g,"&"):f),g=(""+a+e.attachSlashAtStart(c)).replace("//","/");return(g=e.attachSlashAtStart(""+g)).endsWith("/")&&!n&&(g=g.substring(0,g.length-1)),(""+i+g+d+u).replace(/%0D%0A/g,"\n")}}return r.prototype.attachSlashAtStart=function(e){return(e&&e.length>0&&!e.startsWith("/")?"/":"")+e},r.prototype.invoke=function(){return e.__awaiter(this,void 0,void 0,(function(){var r,n,o,a,s;return e.__generator(this,(function(e){switch(e.label){case 0:if(r=t.qs.parse(window.location.search),"string"!=typeof(n=r["liff.state"]))return[2];e.label=1;case 1:return e.trys.push([1,4,,5]),o=location.href,(a=this.decodeState(n))===o?[3,3]:(r["liff.hback"]?location.replace(t.addParamsToUrl(a,{"liff.hback":r["liff.hback"]})):location.replace(a),[4,new Promise((function(){}))]);case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:if((s=e.sent()).code===i.INIT_FAILED)throw s;return d.logger.debug(s),[3,5];case 5:return[2]}}))}))},r}());function V(r,a,u){return e.__awaiter(this,void 0,void 0,(function(){var d;return e.__generator(this,(function(e){switch(e.label){case 0:if(!u.liffId)throw t.createLiffError(i.INVALID_CONFIG,"liffId is necessary for liff.init()");return o.setConfig(u),!s.isInClient()&&n.isLoggedIn()&&(o.getExpireTime()||l.logout()),d=t.qs.parse(window.location.search),!c.isSubWindow()||s.isInClient()?[3,2]:[4,new Promise((function(e){f.getMainWindowOrigin()?e():window.addEventListener("message",(function t(r){var n=r.data,a=r.source,s=r.origin;if(n){var l=n.type,c=n.message;l===i.SUB_WINDOW_HEALTH_CHECK_MESSAGE&&(window.removeEventListener("message",t),c&&o.setAppData(c),f.setMainWindowOrigin(s),a&&a.postMessage&&a.postMessage({status:i.SUB_WINDOW_HEALTH_CHECK_MESSAGE},s),e())}}))}))];case 1:e.sent(),e.label=2;case 2:if(d.error&&d.liffOAuth2Error)throw _=d.error,p=d.error_description,v=_+": "+p.replace(/\+/g," "),t.createLiffError(i.INIT_FAILED,v);return g=d.code,h=o.getLoginTmp(),Boolean(g&&!n.isLoggedIn()&&h&&h.codeVerifier)?[4,P(d.liffClientId)]:[3,4];case 3:e.sent(),e.label=4;case 4:return s.isInClient()?[4,M(r,u)]:[3,6];case 5:return e.sent(),[3,8];case 6:return n.isLoggedIn()?[3,8]:[4,K()];case 7:e.sent(),e.label=8;case 8:return[4,W.invoke()];case 9:return e.sent(),[4,a.runHook("beforeInitFinished")];case 10:return e.sent(),t.replaceUrlCredentialRemoved(window.location.href),[2]}var g,h,_,p,v}))}))}var H=function(){function a(e){this.moduleDriver=e}return Object.defineProperty(a.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),a.prototype.install=function(e){var t=e.liff;return this.liff=t,this.init.bind(this)},a.prototype.init=function(a,s,l){return e.__awaiter(this,void 0,void 0,(function(){var c;return e.__generator(this,(function(e){switch(e.label){case 0:f=this.liff,window&&!window.liff&&(window.liff=f),e.label=1;case 1:return e.trys.push([1,9,,11]),[4,Promise.all([T(this.liff),V(this.liff,this.moduleDriver,a)])];case 2:return e.sent(),w(),[4,this.moduleDriver.runHook("beforeInitSuccess")];case 3:if(e.sent(),!a.withLoginOnExternalBrowser||n.isLoggedIn())return[3,7];if(!o.getAutologinAttempt())return[3,4];throw t.createLiffError(i.INIT_FAILED,"Auto login failure");case 4:return o.setAutologinAttempt(),this.liff.login(),[4,new Promise((function(){}))];case 5:e.sent(),e.label=6;case 6:return[3,8];case 7:a.withLoginOnExternalBrowser&&o.clearAutologinAttempt(),e.label=8;case 8:return"function"==typeof s&&s(),r.done(),[3,11];case 9:return c=e.sent(),[4,this.moduleDriver.runHook("initError",c)];case 10:throw e.sent(),"function"==typeof l&&l(c),c;case 11:return[2]}var f}))}))},a}();exports.InitModule=H;
