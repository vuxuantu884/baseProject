"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@liff/consts"),r=require("@liff/util"),t=require("@liff/is-in-client"),n=require("@liff/is-api-available"),i=require("tslib"),o=require("@liff/logger"),s=require("@liff/get-os"),a=require("@liff/server-api"),u=require("@liff/store"),c=require("@liff/is-sub-window"),f=require("@liff/close-window");function l(e){var r=a.getEndPoint("subWindowGetOrigin");return a.fetch(r(e))}var d={};function _(e,r){e&&d[e]&&d[e].forEach((function(e){e(r)}))}var S,I,g,m,w=function(){function t(e){this.storage=e}return t.prototype.getItem=function(e){return this.storage.getItem(this.getKeyPrefix()+":"+e)},t.prototype.setItem=function(e,r){this.storage.setItem(this.getKeyPrefix()+":"+e,r)},t.prototype.removeItem=function(e){this.storage.removeItem(this.getKeyPrefix()+":"+e)},t.prototype.clear=function(){this.storage.clear()},t.prototype.getKeyPrefix=function(){return e.STORE_KEY+":"+this.getLiffId()},t.prototype.getLiffId=function(){var t=u.getConfig().liffId;if(!t)throw r.createLiffError(e.INVALID_CONFIG,"liffId is necessary for liff.init()");return t},t}(),h=new w(r.inMemoryStorage);function p(){var e=h.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function E(e){h.setItem("subWindowStatusUpdated",String(e))}function v(e){S=e}function N(){return S}function O(){return g}function T(){return m}var U=new w(window.sessionStorage);function W(){return U.getItem("mainWindowOrigin")}function L(t,n){return void 0===n&&(n={}),i.__awaiter(this,void 0,void 0,(function(){var s,a,c,f,d,_,S;return i.__generator(this,(function(i){switch(i.label){case 0:if(s=u.getConfig().liffId,a=W(),!window.opener||!a||!s)throw r.createLiffError(e.EXCEPTION_IN_SUBWINDOW);c=!1,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,l(s)];case 2:return f=i.sent(),c=f.subwindowCommonModule,[3,4];case 3:throw d=i.sent(),o.logger.debug(d),r.createLiffError(e.EXCEPTION_IN_SUBWINDOW);case 4:return _=JSON.stringify(n),S=c?a:location.origin,[2,new Promise((function(r){window.addEventListener("message",(function n(i){(function(r){if(r.data&&"string"==typeof r.data.type&&[e.SUB_WINDOW_SUBMIT_STATUS,e.SUB_WINDOW_CANCEL_STATUS].includes(r.data.type))return!0;return!1})(i)&&(window.removeEventListener("message",n),r({status:t,result:_}))})),window.opener.postMessage({status:t,result:_},S)}))]}}))}))}function b(r){var t,n=T();if(r.origin===n){var i=r.data;if(i){var s,a=i.status,u=i.result;try{s=JSON.parse(u||"{}")}catch(c){s={}}switch(a){case e.SUB_WINDOW_HEALTH_CHECK_MESSAGE:window.clearInterval(O());break;case e.SUB_WINDOW_CANCEL_STATUS:case e.SUB_WINDOW_SUBMIT_STATUS:E(!0),window.clearInterval(O()),window.removeEventListener("message",b),_(a,s),null===(t=N())||void 0===t||t.postMessage({type:a},T());break;default:o.logger.debug("unexpected message")}}}}function A(){window.clearInterval(I),window.clearInterval(O()),window.removeEventListener("message",b)}function D(t){var n=r.extractLiffId(t.url);if(!n)return Promise.reject(r.createLiffError(e.INVALID_ARGUMENT,"params.url must be liff url"));!function(){A(),E(!1);var e=N();e&&(e.close(),v(null))}();var o,a,u,c,f=t.url,d=t.appData,S=new URL(f);S.searchParams.append(e.SUB_WINDOW_IDNTIFICATION_KEY,"true"),S.hostname=(o=S.hostname,a=i.__read(o.split(".")),u=a[0],c=a.slice(1),i.__spread([u+"-ext"],c).join("."));var w=S.toString();return v("ios"!==s.getOS()||r.isIpad()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),l(n).then((function(t){var n,i=t.origin,o=t.subwindowCommonModule,s=N();if(!s)throw r.createLiffError(e.CREATE_SUBWINDOW_FAILED);o?(!function(e){m=e}(i),window.addEventListener("message",b),s.location.href=w,n=function(r,t){var n=N(),i={type:e.SUB_WINDOW_HEALTH_CHECK_MESSAGE};return t&&(i.message=JSON.stringify(t)),window.setInterval((function(){null==n||n.postMessage(i,r)}),e.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}(i,d),g=n,function(e){I=e}(window.setInterval((function(){var r=N();r&&r.closed&&(A(),v(null),!1===p()&&(E(!0),_(e.SUB_WINDOW_CLOSE_STATUS,{})))}),e.SUB_WINDOW_MONITOR_CLOSE_INTERVAL))):s.close()}))}function C(t){return i.__awaiter(this,void 0,void 0,(function(){var n,o,s,u,c,f,l,d,_,S,I;return i.__generator(this,(function(i){switch(i.label){case 0:n=t.msit,o=t.mstChallenge,s=t.onSuccess,u=t.onError,c=t.reconnectCount,f=void 0===c?0:c,i.label=1;case 1:return i.trys.push([1,3,,6]),[4,a.requestWithoutErrorHandling(a.getEndPoint("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:n,mstChallenge:o})})];case 2:return l=i.sent(),[3,6];case 3:return i.sent(),[4,y()];case 4:return i.sent(),[4,B(C,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f+=1})];case 5:return i.sent(),[2];case 6:return l.status>=500?[4,y()]:[3,9];case 7:return i.sent(),[4,B(C,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f+=1})];case 8:return i.sent(),[3,20];case 9:return l.status>=400&&500>l.status?[4,P(l)]:[3,11];case 10:return(_=i.sent())?(d=_.errorDetail,u(r.createLiffError(e.INVALID_ARGUMENT,d))):u(r.createLiffError(e.UNKNOWN,"Some error happened in the server")),[3,20];case 11:return 200!==l.status?[3,19]:[4,P(l)];case 12:return(_=i.sent())?[3,13]:(u(r.createLiffError(e.UNKNOWN,"Some error happened in the server")),[3,18]);case 13:switch(S=_.status,I=_.result,S){case e.SUB_WINDOW_ERROR_STATUS:return[3,14];case e.SUB_WINDOW_CLOSE_STATUS:case e.SUB_WINDOW_CANCEL_STATUS:case e.SUB_WINDOW_SUBMIT_STATUS:return[3,16]}return[3,17];case 14:return[4,B(C,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f})];case 15:return i.sent(),[3,18];case 16:return s(S,I),[3,18];case 17:u(r.createLiffError(e.UNKNOWN,"Some error happened in the server")),i.label=18;case 18:return[3,20];case 19:u(r.createLiffError(e.UNKNOWN,"Some error happened in the server")),i.label=20;case 20:return[2]}}))}))}function y(){return new Promise((function(e){return setTimeout(e,1e3)}))}function P(e){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,e.json()];case 1:return[2,r.sent()];case 2:return r.sent(),[2,null];case 3:return[2]}}))}))}function B(t,n){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return n.reconnectCount>=10?(n.onError(r.createLiffError(e.UNKNOWN,"Failed to connect")),[3,3]):[3,1];case 1:return[4,t(n)];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}function M(e){var r={};return Object.keys(e).forEach((function(t){"closeButtonColor"===t?"white"===e[t]?r[t]="#ffffff":r[t]="#000000":r[t]=e[t]})),r}var R={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function H(t){var n=t.appData,i=t.native,o=u.getConfig().liffId,s=u.getMSTChallenge(),c=r.extractLiffId(t.url);if(!o)return Promise.reject(r.createLiffError(e.UNAUTHORIZED,"liffId is invalid"));if(!s)return Promise.reject(r.createLiffError(e.UNAUTHORIZED,"mst_challenge is invalid"));if(!c)return Promise.reject(r.createLiffError(e.INVALID_ARGUMENT,"params.url must be liff url"));var f=Object.assign({},R,i);return function(t){var n=t.mainLiffId,i=t.subLiffId,o=t.mstChallenge,s=t.appData,u=t.view;return n&&o?a.fetch(a.getEndPoint("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:n,subLiffId:i,mstChallenge:o,appData:s,view:u})}):Promise.reject(r.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))}({mainLiffId:o,subLiffId:c,mstChallenge:s,appData:n,view:M(f)}).then((function(r){var n=r.msit;C({msit:n,mstChallenge:s,onSuccess:function(e,r){_(e,r)},onError:function(r){_(e.SUB_WINDOW_ERROR_STATUS,r)}}),function(r,t){var n=r.url,i=new URLSearchParams;i.set("msit",t),location.href=e.SUB_WINDOW_MODAL_SCHEME_URL+"?url="+encodeURIComponent(n)+"&"+i.toString()}(t,n)}))}function j(){if(!c.isSubWindow())throw r.createLiffError(e.UNAUTHORIZED,"this api can be only called in child window")}function x(t){if(!t.mst||!t.status)return Promise.reject(r.createLiffError(e.INVALID_ARGUMENT,"no proper argument"));var n=JSON.stringify(t);return a.fetch(a.getEndPoint("subWindowPost"),{method:"POST",body:n})}var G={on:function(e,r){d[e]||(d[e]=[]),d[e].push(r)},off:function(e,r){if(d[e]){var t=d[e].indexOf(r);t>=0&&d[e].splice(t,1)}},open:function(i){if(!n.isApiAvailable("subwindowOpen"))throw r.createLiffError(e.FORBIDDEN,"No permission for liff.subWindow.open()");return function(){if(c.isSubWindow())throw r.createLiffError(e.UNAUTHORIZED,"this api can be only called in parent window")}(),t.isInClient()?H(i):D(i)},cancel:function(n){return void 0===n&&(n={}),j(),t.isInClient()?function(t){return void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){var n,o;return i.__generator(this,(function(i){switch(i.label){case 0:return(n=u.getMST())?[4,x({mst:n,status:e.SUB_WINDOW_CANCEL_STATUS,result:t})]:[2,Promise.reject(r.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:return o=i.sent(),E(!0),[2,o]}}))}))}(n):function(r){return void 0===r&&(r={}),L(e.SUB_WINDOW_CANCEL_STATUS,r)}(n)},submit:function(n){return void 0===n&&(n={}),j(),t.isInClient()?function(t){return void 0===t&&(t={}),i.__awaiter(this,void 0,void 0,(function(){var n,o;return i.__generator(this,(function(i){switch(i.label){case 0:return(n=u.getMST())?[4,x({mst:n,status:e.SUB_WINDOW_SUBMIT_STATUS,result:t})]:[2,Promise.reject(r.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:return o=i.sent(),E(!0),[2,o]}}))}))}(n):function(r){return void 0===r&&(r={}),L(e.SUB_WINDOW_SUBMIT_STATUS,r)}(n)},close:function(){return j(),t.isInClient()?function(){return i.__awaiter(this,void 0,void 0,(function(){var t;return i.__generator(this,(function(n){switch(n.label){case 0:return!1!==p()?[3,2]:(t=u.getMST())?[4,x({mst:t,status:e.SUB_WINDOW_CLOSE_STATUS,result:{}})]:[2,Promise.reject(r.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:n.sent(),n.label=2;case 2:return f.closeWindow(),[2]}}))}))}():(f.closeWindow(),Promise.resolve())},getAppData:function(){return j(),function(){var e,r=u.getAppData();try{e=r?JSON.parse(r):{}}catch(t){e={}}return Promise.resolve(e)}()}};exports.getAppData=function(t){var n=t.mst;return n?a.fetch(a.getEndPoint("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:n})}):Promise.reject(r.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))},exports.getMSTByMSIT=function(t){var n=t.msit,i=t.mstVerifier;return n&&i?a.fetch(a.getEndPoint("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:n,mstVerifier:i})}):Promise.reject(r.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))},exports.getMainWindowOrigin=W,exports.setMainWindowOrigin=function(e){U.setItem("mainWindowOrigin",e)},exports.subWindow=G;
