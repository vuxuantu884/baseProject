import{STORE_KEY as e,INVALID_CONFIG as t,EXCEPTION_IN_SUBWINDOW as n,SUB_WINDOW_SUBMIT_STATUS as r,SUB_WINDOW_CANCEL_STATUS as i,INVALID_ARGUMENT as o,SUB_WINDOW_IDNTIFICATION_KEY as s,CREATE_SUBWINDOW_FAILED as u,SUB_WINDOW_HEALTH_CHECK_INTERVAL as a,SUB_WINDOW_MONITOR_CLOSE_INTERVAL as c,SUB_WINDOW_HEALTH_CHECK_MESSAGE as f,SUB_WINDOW_CLOSE_STATUS as l,UNKNOWN as m,SUB_WINDOW_ERROR_STATUS as d,UNAUTHORIZED as p,SUB_WINDOW_MODAL_SCHEME_URL as v,FORBIDDEN as h}from"@liff/consts";import{createLiffError as w,inMemoryStorage as g,extractLiffId as b,isIpad as y}from"@liff/util";import{isInClient as S}from"@liff/is-in-client";import{isApiAvailable as I}from"@liff/is-api-available";import{__awaiter as P,__generator as O,__spread as C,__read as L}from"tslib";import{logger as j}from"@liff/logger";import{getOS as E}from"@liff/get-os";import{fetch as N,getEndPoint as W,requestWithoutErrorHandling as J}from"@liff/server-api";import{getConfig as D,getMSTChallenge as T,getMST as x,getAppData as M}from"@liff/store";import{isSubWindow as B}from"@liff/is-sub-window";import{closeWindow as U}from"@liff/close-window";function k(e){var t=W("subWindowGetOrigin");return N(t(e))}var G={};function K(e,t){e&&G[e]&&G[e].forEach((function(e){e(t)}))}var A,R,V,F,_=function(){function n(e){this.storage=e}return n.prototype.getItem=function(e){return this.storage.getItem(this.getKeyPrefix()+":"+e)},n.prototype.setItem=function(e,t){this.storage.setItem(this.getKeyPrefix()+":"+e,t)},n.prototype.removeItem=function(e){this.storage.removeItem(this.getKeyPrefix()+":"+e)},n.prototype.clear=function(){this.storage.clear()},n.prototype.getKeyPrefix=function(){return e+":"+this.getLiffId()},n.prototype.getLiffId=function(){var e=D().liffId;if(!e)throw w(t,"liffId is necessary for liff.init()");return e},n}(),q=new _(g);function z(){var e=q.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function H(e){q.setItem("subWindowStatusUpdated",String(e))}function Q(e){A=e}function X(){return A}function Y(){return V}function Z(){return F}var $=new _(window.sessionStorage);function ee(e){$.setItem("mainWindowOrigin",e)}function te(){return $.getItem("mainWindowOrigin")}function ne(e,t){return void 0===t&&(t={}),P(this,void 0,void 0,(function(){var o,s,u,a,c,f,l;return O(this,(function(m){switch(m.label){case 0:if(o=D().liffId,s=te(),!window.opener||!s||!o)throw w(n);u=!1,m.label=1;case 1:return m.trys.push([1,3,,4]),[4,k(o)];case 2:return a=m.sent(),u=a.subwindowCommonModule,[3,4];case 3:throw c=m.sent(),j.debug(c),w(n);case 4:return f=JSON.stringify(t),l=u?s:location.origin,[2,new Promise((function(t){window.addEventListener("message",(function n(o){(function(e){if(e.data&&"string"==typeof e.data.type&&[r,i].includes(e.data.type))return!0;return!1})(o)&&(window.removeEventListener("message",n),t({status:e,result:f}))})),window.opener.postMessage({status:e,result:f},l)}))]}}))}))}function re(e){var t,n=Z();if(e.origin===n){var o=e.data;if(o){var s,u=o.status,a=o.result;try{s=JSON.parse(a||"{}")}catch(c){s={}}switch(u){case f:window.clearInterval(Y());break;case i:case r:H(!0),window.clearInterval(Y()),window.removeEventListener("message",re),K(u,s),null===(t=X())||void 0===t||t.postMessage({type:u},Z());break;default:j.debug("unexpected message")}}}}function ie(){window.clearInterval(R),window.clearInterval(Y()),window.removeEventListener("message",re)}function oe(e){var t=b(e.url);if(!t)return Promise.reject(w(o,"params.url must be liff url"));!function(){ie(),H(!1);var e=X();e&&(e.close(),Q(null))}();var n,r,i,m,d=e.url,p=e.appData,v=new URL(d);v.searchParams.append(s,"true"),v.hostname=(n=v.hostname,r=L(n.split(".")),i=r[0],m=r.slice(1),C([i+"-ext"],m).join("."));var h=v.toString();return Q("ios"!==E()||y()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),k(t).then((function(e){var t,n=e.origin,r=e.subwindowCommonModule,i=X();if(!i)throw w(u);r?(!function(e){F=e}(n),window.addEventListener("message",re),i.location.href=h,t=function(e,t){var n=X(),r={type:f};return t&&(r.message=JSON.stringify(t)),window.setInterval((function(){null==n||n.postMessage(r,e)}),a)}(n,p),V=t,function(e){R=e}(window.setInterval((function(){var e=X();e&&e.closed&&(ie(),Q(null),!1===z()&&(H(!0),K(l,{})))}),c))):i.close()}))}function se(e){return P(this,void 0,void 0,(function(){var t,n,s,u,a,c,f,p,v,h,g;return O(this,(function(b){switch(b.label){case 0:t=e.msit,n=e.mstChallenge,s=e.onSuccess,u=e.onError,a=e.reconnectCount,c=void 0===a?0:a,b.label=1;case 1:return b.trys.push([1,3,,6]),[4,J(W("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:t,mstChallenge:n})})];case 2:return f=b.sent(),[3,6];case 3:return b.sent(),[4,ue()];case 4:return b.sent(),[4,ce(se,{msit:t,mstChallenge:n,onSuccess:s,onError:u,reconnectCount:c+=1})];case 5:return b.sent(),[2];case 6:return f.status>=500?[4,ue()]:[3,9];case 7:return b.sent(),[4,ce(se,{msit:t,mstChallenge:n,onSuccess:s,onError:u,reconnectCount:c+=1})];case 8:return b.sent(),[3,20];case 9:return f.status>=400&&500>f.status?[4,ae(f)]:[3,11];case 10:return(v=b.sent())?(p=v.errorDetail,u(w(o,p))):u(w(m,"Some error happened in the server")),[3,20];case 11:return 200!==f.status?[3,19]:[4,ae(f)];case 12:return(v=b.sent())?[3,13]:(u(w(m,"Some error happened in the server")),[3,18]);case 13:switch(h=v.status,g=v.result,h){case d:return[3,14];case l:case i:case r:return[3,16]}return[3,17];case 14:return[4,ce(se,{msit:t,mstChallenge:n,onSuccess:s,onError:u,reconnectCount:c})];case 15:return b.sent(),[3,18];case 16:return s(h,g),[3,18];case 17:u(w(m,"Some error happened in the server")),b.label=18;case 18:return[3,20];case 19:u(w(m,"Some error happened in the server")),b.label=20;case 20:return[2]}}))}))}function ue(){return new Promise((function(e){return setTimeout(e,1e3)}))}function ae(e){return P(this,void 0,void 0,(function(){return O(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e.json()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))}function ce(e,t){return P(this,void 0,void 0,(function(){return O(this,(function(n){switch(n.label){case 0:return t.reconnectCount>=10?(t.onError(w(m,"Failed to connect")),[3,3]):[3,1];case 1:return[4,e(t)];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}function fe(e){var t={};return Object.keys(e).forEach((function(n){"closeButtonColor"===n?"white"===e[n]?t[n]="#ffffff":t[n]="#000000":t[n]=e[n]})),t}var le={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function me(e){var t=e.appData,n=e.native,r=D().liffId,i=T(),s=b(e.url);if(!r)return Promise.reject(w(p,"liffId is invalid"));if(!i)return Promise.reject(w(p,"mst_challenge is invalid"));if(!s)return Promise.reject(w(o,"params.url must be liff url"));var u=Object.assign({},le,n);return function(e){var t=e.mainLiffId,n=e.subLiffId,r=e.mstChallenge,i=e.appData,s=e.view;return t&&r?N(W("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:n,mstChallenge:r,appData:i,view:s})}):Promise.reject(w(o,"no proper argument"))}({mainLiffId:r,subLiffId:s,mstChallenge:i,appData:t,view:fe(u)}).then((function(t){var n=t.msit;se({msit:n,mstChallenge:i,onSuccess:function(e,t){K(e,t)},onError:function(e){K(d,e)}}),function(e,t){var n=e.url,r=new URLSearchParams;r.set("msit",t),location.href=v+"?url="+encodeURIComponent(n)+"&"+r.toString()}(e,n)}))}function de(){if(!B())throw w(p,"this api can be only called in child window")}function pe(e){if(!e.mst||!e.status)return Promise.reject(w(o,"no proper argument"));var t=JSON.stringify(e);return N(W("subWindowPost"),{method:"POST",body:t})}function ve(e){var t=e.msit,n=e.mstVerifier;return t&&n?N(W("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:n})}):Promise.reject(w(o,"no proper argument"))}function he(e){var t=e.mst;return t?N(W("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(w(o,"no proper argument"))}var we={on:function(e,t){G[e]||(G[e]=[]),G[e].push(t)},off:function(e,t){if(G[e]){var n=G[e].indexOf(t);n>=0&&G[e].splice(n,1)}},open:function(e){if(!I("subwindowOpen"))throw w(h,"No permission for liff.subWindow.open()");return function(){if(B())throw w(p,"this api can be only called in parent window")}(),S()?me(e):oe(e)},cancel:function(e){return void 0===e&&(e={}),de(),S()?function(e){return void 0===e&&(e={}),P(this,void 0,void 0,(function(){var t,n;return O(this,(function(r){switch(r.label){case 0:return(t=x())?[4,pe({mst:t,status:i,result:e})]:[2,Promise.reject(w(p,"mst is invalid"))];case 1:return n=r.sent(),H(!0),[2,n]}}))}))}(e):function(e){return void 0===e&&(e={}),ne(i,e)}(e)},submit:function(e){return void 0===e&&(e={}),de(),S()?function(e){return void 0===e&&(e={}),P(this,void 0,void 0,(function(){var t,n;return O(this,(function(i){switch(i.label){case 0:return(t=x())?[4,pe({mst:t,status:r,result:e})]:[2,Promise.reject(w(p,"mst is invalid"))];case 1:return n=i.sent(),H(!0),[2,n]}}))}))}(e):function(e){return void 0===e&&(e={}),ne(r,e)}(e)},close:function(){return de(),S()?function(){return P(this,void 0,void 0,(function(){var e;return O(this,(function(t){switch(t.label){case 0:return!1!==z()?[3,2]:(e=x())?[4,pe({mst:e,status:l,result:{}})]:[2,Promise.reject(w(p,"mst is invalid"))];case 1:t.sent(),t.label=2;case 2:return U(),[2]}}))}))}():(U(),Promise.resolve())},getAppData:function(){return de(),function(){var e,t=M();try{e=t?JSON.parse(t):{}}catch(n){e={}}return Promise.resolve(e)}()}};export{he as getAppData,ve as getMSTByMSIT,te as getMainWindowOrigin,ee as setMainWindowOrigin,we as subWindow};
